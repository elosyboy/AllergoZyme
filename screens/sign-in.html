<!-- screens/sign-in.html -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AllergoZyme — Identification</title>
  <meta name="theme-color" content="#ffffff" />

  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet" />
  <!-- Précharge du logo -->
  <link rel="preload" href="../assets/logo.png" as="image" />

  <style>
    :root{
      --gold-a:#B8892E; --gold-b:#D4AF37; --gold-c:#F0D27A;
      --bg:#ffffff; --text:#111111; --muted:#6b7280; --ring: rgba(212,175,55,.35); --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .wrap{min-height:100dvh;display:grid;place-items:center;padding:32px;position:relative;isolation:isolate;}
    .halo{
      position:absolute; inset:auto -20% 25% -20%;
      height:280px; filter:blur(60px); opacity:.15; z-index:-1;
      background:radial-gradient(60% 100% at 50% 50%,var(--gold-c),transparent 70%);
    }
    .card{
      width:min(560px,100%); display:flex; flex-direction:column; align-items:center; gap:22px; text-align:center;
      background:rgba(255,255,255,.72); border:1px solid rgba(0,0,0,.06); border-radius:28px; padding:32px 24px 28px;
      box-shadow:0 18px 50px rgba(0,0,0,.10), inset 0 1px 0 rgba(255,255,255,.65); backdrop-filter:blur(8px);
    }

    /* Logo (pas de fallback texte) */
    .logo{width:160px;height:160px;display:flex;align-items:center;justify-content:center;}
    #app-logo{width:100%;height:100%;object-fit:contain;display:block;-webkit-user-drag:none;user-select:none;}

    .title{
      font-weight:900; font-size:28px; margin:0;
      background:linear-gradient(120deg,var(--gold-a),var(--gold-b),var(--gold-c));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      animation: goldShift 8s ease-in-out infinite;
    }
    .subtitle{font-size:14px;color:var(--muted);margin-top:-6px;}

    form{width:100%;max-width:460px;display:flex;flex-direction:column;gap:16px;text-align:left;}
    .group{
      border:1px solid #eee; border-radius:16px; padding:14px; background:#fff;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.7);
    }
    .group-title{
      margin:0 0 10px 0; font-size:14px; font-weight:900;
      background:linear-gradient(120deg,var(--gold-a),var(--gold-b),var(--gold-c));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{
      font-size:14px; font-weight:700;
      background:linear-gradient(120deg,var(--gold-a),var(--gold-b),var(--gold-c));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .field input{
      border:1px solid #ddd; border-radius:12px; padding:12px 14px; font-size:16px; outline:none; background:#fff;
    }
    .field input:focus{ border-color:var(--gold-b); box-shadow:0 0 0 2px rgba(212,175,55,.28); }

    .error{
      display:none; background:#fee2e2; color:var(--danger); border:1px solid #fecaca;
      padding:10px 12px; border-radius:10px; font-size:13px;
    }
    .error.show{display:block;}

    .btn{
      width:100%; max-width:460px; appearance:none; border:none; cursor:pointer;
      color:#fff; font-weight:800; font-size:18px; padding:16px 24px; border-radius:999px;
      background:linear-gradient(135deg,var(--gold-a),var(--gold-b),var(--gold-c));
      box-shadow:0 14px 30px rgba(212,175,55,.25), inset 0 1px 0 rgba(255,255,255,.45);
      transition: transform .08s ease, opacity .08s ease, box-shadow .12s ease;
      position:relative; overflow:hidden; text-decoration:none; text-align:center;
    }
    .btn::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(100deg,transparent 0%,rgba(255,255,255,.35) 40%,transparent 60%);
      transform:translateX(-120%); transition:transform .6s ease; mix-blend-mode:soft-light;
    }
    .btn:hover::after{ transform:translateX(120%); }
    .btn:hover{ transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); opacity:.92; }
    .btn[disabled]{ opacity:.7; filter:grayscale(.15); cursor:not-allowed; }
    .btn:focus-visible{ outline:2px solid var(--ring); outline-offset:3px; }

    .links{display:flex;flex-direction:column;gap:6px;}
    .link{
      background:linear-gradient(120deg,var(--gold-a),var(--gold-b),var(--gold-c));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      font-size:14px; font-weight:800; cursor:pointer; text-decoration:none; text-align:center;
    }
    .muted{color:var(--muted);font-size:14px;text-align:center;}
    .muted a{
      background:linear-gradient(120deg,var(--gold-a),var(--gold-b),var(--gold-c));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      font-weight:900; text-decoration:none;
    }

    @media (prefers-reduced-motion: reduce){
      .btn::after,.btn,.title{animation:none!important;transition:none!important;}
    }
    @keyframes goldShift{0%,100%{filter:hue-rotate(0deg) brightness(1);}50%{filter:hue-rotate(-8deg) brightness(1.05);}}
    @supports(padding:max(0px)){
      .wrap{padding:max(32px,env(safe-area-inset-top)) max(32px,env(safe-area-inset-right)) max(32px,env(safe-area-inset-bottom)) max(32px,env(safe-area-inset-left));}
    }
    noscript{display:block;text-align:center;color:#b91c1c;font-weight:700;margin-top:12px;}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="halo" aria-hidden="true"></div>

    <section class="card" aria-labelledby="title">
      <!-- Logo -->
      <div class="logo" aria-hidden="true">
        <img id="app-logo" alt="Logo AllergoZyme">
      </div>

      <!-- Titres -->
      <h1 id="title" class="title">Identification</h1>
      <div class="subtitle">Connectez-vous pour accéder au tableau de bord.</div>

      <!-- Erreur -->
      <div id="error" class="error" role="alert" aria-live="polite"></div>

      <!-- Formulaire -->
      <form id="form" novalidate>
        <div class="group">
          <div class="group-title">Compte</div>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="ex: toi@email.com" required />
          </div>
          <div class="field">
            <label for="password">Mot de passe</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
          </div>
        </div>

        <button id="submit" type="submit" class="btn">Se connecter</button>
      </form>

      <!-- Liens -->
      <div class="links">
        <a class="link" id="forgot" href="javascript:void(0)">Mot de passe oublié ?</a>
        <div class="muted">Pas de compte ? <a id="to-signup" href="./sign-up.html">Créer un compte</a></div>
      </div>

      <noscript>JavaScript est requis pour se connecter.</noscript>
    </section>
  </main>

  <!-- IMPORTANT : ordre des scripts (Supabase -> env -> app -> adapter) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../scripts/env.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/supabase-adapter.js"></script>

  <script>
    // 1) Logo : essaie plusieurs chemins (local, Docker/nginx)
    (function loadLogo(){
      const img = document.getElementById('app-logo'); if(!img) return;
      const candidates = [
        '../assets/logo.png','../assets/Logo.png','../assets/logo.svg',
        '/assets/logo.png','/assets/Logo.png','/assets/logo.svg',
        './assets/logo.png','./assets/Logo.png','./assets/logo.svg'
      ];
      let i = 0; const probe = new Image();
      const tryNext = () => {
        if(i >= candidates.length) return;
        const url = candidates[i++]; probe.onload = () => { img.src = url; };
        probe.onerror = tryNext; probe.src = url;
      };
      tryNext();
    })();

    // 2) Corrige le lien si la page n’est pas servie depuis /screens/
    (function ensurePaths(){
      const inScreens = location.pathname.includes('/screens/');
      if(!inScreens){
        const signup = document.getElementById('to-signup');
        if (signup && !signup.getAttribute('href')?.includes('screens/')) {
          signup.setAttribute('href','./screens/sign-up.html');
        }
      }
    })();

    // 3) Redirection auto si déjà connecté (local OU Supabase via adapter)
    (function autoRedirect(){
      const goDash = me => { if(me) AZ.path.go('dashboard'); };
      const run = () => Promise.resolve(AZ.currentUser && AZ.currentUser()).then(goDash).catch(()=>{});
      if (window.AZ) run();
      document.addEventListener('AZ_READY', run, { once:true });
    })();

    // 4) Gestion du formulaire
    const form   = document.getElementById('form');
    const emailEl= document.getElementById('email');
    const passEl = document.getElementById('password');
    const btn    = document.getElementById('submit');
    const errBox = document.getElementById('error');

    function showError(msg){ errBox.textContent = msg; errBox.classList.add('show'); }
    function clearError(){ errBox.textContent = ''; errBox.classList.remove('show'); }

    form?.addEventListener('submit', async (e)=>{
      e.preventDefault(); clearError();
      const email = (emailEl.value || '').trim();
      const password = passEl.value || '';
      if (!email || !password){ showError('Merci de renseigner votre email et votre mot de passe.'); return; }

      try{
        btn.disabled = true;
        await (window.AZ ? AZ.signIn(email, password) : Promise.reject(new Error('App non initialisée')));
        AZ.path.go('dashboard');
      }catch(err){
        showError(err?.message || 'Connexion impossible. Vérifiez vos identifiants.');
      }finally{
        btn.disabled = false;
      }
    });

    // 5) Mot de passe oublié (placeholder)
    document.getElementById('forgot')?.addEventListener('click', ()=>{
      alert("La réinitialisation de mot de passe s’activera quand on passera en ligne (email de réinitialisation).");
    });
  </script>
</body>
</html>
